name: Packages Deps Auto Merge

on:
  workflow_run:
    workflows:
      - Packages Deps Check
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto merge dependency update PR
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.head_branch == 'chore/deps-auto-update' &&
      github.event.workflow_run.head_repository.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Merge dependency update pull request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${PR_NUMBER:-}" ]]; then
            echo "No pull request attached to workflow_run"
            exit 0
          fi

          pr_state="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json state -q .state)"
          pr_head="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json headRefName -q .headRefName)"
          pr_base="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json baseRefName -q .baseRefName)"
          pr_author="$(gh pr view "$PR_NUMBER" --repo "$REPO" --json author -q .author.login)"

          if [[ "$pr_state" != "OPEN" ]]; then
            echo "PR #$PR_NUMBER is not open, skip"
            exit 0
          fi

          if [[ "$pr_head" != "chore/deps-auto-update" || "$pr_base" != "main" ]]; then
            echo "PR #$PR_NUMBER does not match target branch rules, skip"
            exit 0
          fi

          if [[ "$pr_author" != "github-actions[bot]" ]]; then
            echo "PR #$PR_NUMBER author is $pr_author, skip"
            exit 0
          fi

          gh pr merge "$PR_NUMBER" \
            --repo "$REPO" \
            --squash \
            --delete-branch
